FROM ubuntu:22.04

# --- 1. CÀI ĐẶT MÔI TRƯỜNG & JAVA 21 (Bắt buộc cho MC 1.21.1) ---
ENV DEBIAN_FRONTEND=noninteractive
RUN apt-get update && apt-get install -y \
    curl wget sudo nano unzip \
    openssh-server \
    net-tools iputils-ping \
    ca-certificates \
    # Cài đặt Java 21 để chạy server.jar
    openjdk-21-jre-headless \
    # Cài đặt Docker CLI để dùng lệnh docker bên trong
    docker.io \
    iptables \
    && rm -rf /var/lib/apt/lists/* \
    && mkdir /var/un/sshd

# --- 2. CẤU HÌNH SSH & ROOT ---
RUN sed -i 's/#PermitRootLogin prohibit-password/PermitRootLogin yes/' /etc/ssh/sshd_config && \
    sed -i 's/#PasswordAuthentication yes/PasswordAuthentication yes/' /etc/ssh/sshd_config && \
    echo "root:123456" | chpasswd

# --- 3. TẠO USER trthaodev ---
RUN useradd -m -s /bin/bash trthaodev && \
    echo "trthaodev:thaodev@" | chpasswd && \
    usermod -aG sudo trthaodev && \
    usermod -aG docker trthaodev && \
    echo "trthaodev ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers

# --- 4. CÀI ĐẶT CLOUDFLARED & FILEBROWSER ---
RUN wget -q https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb && \
    dpkg -i cloudflared-linux-amd64.deb && \
    rm cloudflared-linux-amd64.deb && \
    curl -fsSL https://raw.githubusercontent.com/filebrowser/get/master/get.sh | bash

# --- 5. SCRIPT KHỞI ĐỘNG (Sửa lỗi Docker Socket) ---
RUN echo '#!/bin/bash' > /start.sh && \
    echo 'echo "=== DANG KHOI DONG HE THONG ==="' >> /start.sh && \
    # Tự động cấp quyền cho docker socket nếu được mount vào
    echo 'if [ -S /var/run/docker.sock ]; then chmod 666 /var/run/docker.sock; fi' >> /start.sh && \
    echo 'service ssh start' >> /start.sh && \
    # Chạy FileBrowser ở thư mục gốc để quản lý file
    echo 'nohup filebrowser -r / -p 8080 --no-auth > /var/log/fb.log 2>&1 &' >> /start.sh && \
    echo 'if [ ! -z "$CF_TOKEN" ]; then' >> /start.sh && \
    echo '  echo "1. Dang ket noi Cloudflare Tunnel..."' >> /start.sh && \
    echo '  cloudflared tunnel run --token $CF_TOKEN' >> /start.sh && \
    echo 'else' >> /start.sh && \
    echo '  echo "⚠️ Thieu CF_TOKEN! Giu container chay bang tail..."' >> /start.sh && \
    echo '  tail -f /dev/null' >> /start.sh && \
    echo 'fi' >> /start.sh && \
    chmod +x /start.sh

# --- 6. KHAI BÁO PORT ---
# 25565: Minecraft | 8080: FileBrowser | 22: SSH
EXPOSE 25565 8080 22

CMD ["/start.sh"]
